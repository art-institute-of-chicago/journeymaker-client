/*! Tuio.js - v0.0.1 - 2012-10-14
* http://fe9lix.github.com/Tuio.js/
* Copyright (c) 2012 Felix Raab; Licensed GPL */
(function(a){var b=a.Tuio,c=Array.prototype.slice,d=Array.prototype.splice,e;typeof exports!="undefined"?e=exports:e=a.Tuio={},e.VERSION="0.0.1";var f=a._;!f&&typeof require!="undefined"&&(f=require("lodash")),e.noConflict=function(){return a.Tuio=b,this};var g=/\s+/,h=e.Events={on:function(a,b,c){var d,e,f,h,i;if(!b)return this;a=a.split(g),d=this._callbacks||(this._callbacks={});while(e=a.shift())i=d[e],f=i?i.tail:{},f.next=h={},f.context=c,f.callback=b,d[e]={tail:h,next:i?i.next:f};return this},off:function(a,b,c){var d,e,h,i,j,k;if(!(e=this._callbacks))return;if(!(a||b||c))return delete this._callbacks,this;a=a?a.split(g):f.keys(e);while(d=a.shift()){h=e[d],delete e[d];if(!h||!b&&!c)continue;i=h.tail;while((h=h.next)!==i)j=h.callback,k=h.context,(b&&j!==b||c&&k!==c)&&this.on(d,j,k)}return this},trigger:function(a){var b,d,e,f,h,i,j;if(!(e=this._callbacks))return this;i=e.all,a=a.split(g),j=c.call(arguments,1);while(b=a.shift()){if(d=e[b]){f=d.tail;while((d=d.next)!==f)d.callback.apply(d.context||this,j)}if(d=i){f=d.tail,h=[b].concat(j);while((d=d.next)!==f)d.callback.apply(d.context||this,h)}}return this}},i=e.Model=function(){this.initialize.apply(this,arguments)};f.extend(i.prototype,h);var j=function(a,b){var c=l(this,a,b);return c.extend=this.extend,c};e.Model.extend=j;var k=function(){},l=function(a,b,c){var d;return b&&b.hasOwnProperty("constructor")?d=b.constructor:d=function(){a.apply(this,arguments)},f.extend(d,a),k.prototype=a.prototype,d.prototype=new k,b&&f.extend(d.prototype,b),c&&f.extend(d,c),d.prototype.constructor=d,d.__super__=a.prototype,d}})(this),Tuio.Time=Tuio.Model.extend({seconds:0,microSeconds:0,initialize:function(a,b){this.seconds=a||0,this.microSeconds=b||0},add:function(a){return new Tuio.Time(this.seconds+Math.floor(a/1e6),this.microSeconds+a%1e6)},addTime:function(a){var b=this.seconds+a.getSeconds(),c=this.microSeconds+a.getMicroseconds();return b+=Math.floor(c/1e6),c=c%1e6,new Tuio.Time(b,c)},subtract:function(a){var b=this.seconds-Math.floor(a/1e6),c=this.microSeconds-a%1e6;return c<0&&(c+=1e6,b=b-1),new Tuio.Time(b,c)},subtractTime:function(a){var b=this.seconds-a.getSeconds(),c=this.microSeconds-a.getMicroseconds();return c<0&&(c+=1e6,b=b-1),new Tuio.Time(b,c)},equals:function(a){return this.seconds===a.getSeconds()&&this.microSeconds===a.getMicroseconds()},reset:function(){this.seconds=0,this.microSeconds=0},getSeconds:function(){return this.seconds},getMicroseconds:function(){return this.microSeconds},getTotalMilliseconds:function(){return this.seconds*1e3+Math.floor(this.microSeconds/1e3)}},{startSeconds:0,startMicroSeconds:0,fromMilliseconds:function(a){return new Tuio.Time(Math.floor(a/1e3),1e3*(a%1e3))},fromTime:function(a){return new Tuio.Time(a.getSeconds(),a.getMicroseconds())},initSession:function(){var a=Tuio.Time.getSystemTime();Tuio.Time.startSeconds=a.getSeconds(),Tuio.Time.startMicroSeconds=a.getMicroseconds()},getSessionTime:function(){return Tuio.Time.getSystemTime().subtractTime(Tuio.Time.getStartTime())},getStartTime:function(){return new Tuio.Time(Tuio.Time.startSeconds,Tuio.Time.startMicroSeconds)},getSystemTime:function(){var a=(new Date).getTime()*1e3;return new Tuio.Time(Math.floor(a/1e6),a%1e6)}}),Tuio.Point=Tuio.Model.extend({xPos:null,yPos:null,currentTime:null,startTime:null,initialize:function(a){this.xPos=a.xp||0,this.yPos=a.yp||0,this.currentTime=Tuio.Time.fromTime(a.ttime||Tuio.Time.getSessionTime()),this.startTime=Tuio.Time.fromTime(this.currentTime)},update:function(a){this.xPos=a.xp,this.yPos=a.yp,a.hasOwnProperty("ttime")&&(this.currentTime=Tuio.Time.fromTime(a.ttime))},updateToPoint:function(a){this.xPos=a.getX(),this.yPos=a.getY()},getX:function(){return this.xPos},getY:function(){return this.yPos},getDistance:function(a,b){var c=this.xPos-a,d=this.yPos-b;return Math.sqrt(c*c+d*d)},getDistanceToPoint:function(a){return this.getDistance(a.getX(),a.getY())},getAngle:function(a,b){var c=this.xPos-a,d=this.yPos-b,e=this.getDistance(a,b),f=Math.asin(c/e)+Math.PI/2;return d<0&&(f=2*Math.PI-f),f},getAngleToPoint:function(a){return this.getAngle(a.getX(),a.getY())},getAngleDegrees:function(a,b){return this.getAngle(a,b)/Math.PI*180},getAngleDegreesToPoint:function(a){return this.getAngleToPoint(a)/Math.PI*180},getScreenX:function(a){return Math.round(this.xPos*a)},getScreenY:function(a){return Math.round(this.yPos*a)},getTuioTime:function(){return Tuio.Time.fromTime(this.currentTime)},getStartTime:function(){return Tuio.Time.fromTime(this.startTime)}},{fromPoint:function(a){return new Tuio.Point({xp:a.getX(),yp:a.getY()})}}),Tuio.Container=Tuio.Point.extend({sessionId:null,xSpeed:null,ySpeed:null,motionSpeed:null,motionAccel:null,path:null,state:null,initialize:function(a){Tuio.Point.prototype.initialize.call(this,a),this.sessionId=a.si,this.xSpeed=0,this.ySpeed=0,this.motionSpeed=0,this.motionAccel=0,this.path=[new Tuio.Point({ttime:this.currentTime,xp:this.xPos,yp:this.yPos})],this.state=Tuio.Container.TUIO_ADDED},update:function(a){var b=this.path[this.path.length-1];Tuio.Point.prototype.update.call(this,a);if(a.hasOwnProperty("xs")&&a.hasOwnProperty("ys")&&a.hasOwnProperty("ma"))this.xSpeed=a.xs,this.ySpeed=a.ys,this.motionSpeed=Math.sqrt(this.xSpeed*this.xSpeed+this.ySpeed*this.ySpeed),this.motionAccel=a.ma;else{var c=this.currentTime.subtractTime(b.getTuioTime()),d=c.getTotalMilliseconds()/1e3,e=this.xPos-b.getX(),f=this.yPos-b.getY(),g=Math.sqrt(e*e+f*f),h=this.motionSpeed;this.xSpeed=e/d,this.ySpeed=f/d,this.motionSpeed=g/d,this.motionAccel=(this.motionSpeed-h)/d}this.updatePathAndState()},updateContainer:function(a){Tuio.Point.prototype.updateToPoint.call(this,a),this.xSpeed=a.getXSpeed(),this.ySpeed=a.getYSpeed(),this.motionSpeed=a.getMotionSpeed(),this.motionAccel=a.getMotionAccel(),this.updatePathAndState()},updatePathAndState:function(){this.path.push(new Tuio.Point({ttime:this.currentTime,xp:this.xPos,yp:this.yPos})),this.motionAccel>0?this.state=Tuio.Container.TUIO_ACCELERATING:this.motionAccel<0?this.state=Tuio.Container.TUIO_DECELERATING:this.state=Tuio.Container.TUIO_STOPPED},stop:function(a){this.update({ttime:a,xp:this.xPos,yp:this.yPos})},remove:function(a){this.currentTime=Tuio.Time.fromTime(a),this.state=Tuio.Container.TUIO_REMOVED},getSessionId:function(){return this.sessionId},getXSpeed:function(){return this.xSpeed},getYSpeed:function(){return this.ySpeed},getPosition:function(){return new Tuio.Point(this.xPos,this.yPos)},getPath:function(){return this.path},getMotionSpeed:function(){return this.motionSpeed},getMotionAccel:function(){return this.motionAccel},getTuioState:function(){return this.state},isMoving:function(){return this.state===Tuio.Container.TUIO_ACCELERATING||this.state===Tuio.Container.TUIO_DECELERATING}},{TUIO_ADDED:0,TUIO_ACCELERATING:1,TUIO_DECELERATING:2,TUIO_STOPPED:3,TUIO_REMOVED:4,fromContainer:function(a){return new Tuio.Container({xp:a.getX(),yp:a.getY(),si:a.getSessionID()})}}),Tuio.Cursor=Tuio.Container.extend({cursorId:null,initialize:function(a){Tuio.Container.prototype.initialize.call(this,a),this.cursorId=a.ci},getCursorId:function(){return this.cursorId}},{fromCursor:function(a){return new Tuio.Cursor({si:a.getSessionId(),ci:a.getCursorId(),xp:a.getX(),yp:a.getY()})}}),Tuio.Object=Tuio.Container.extend({symbolId:null,angle:null,rotationSpeed:null,rotationAccel:null,initialize:function(a){Tuio.Container.prototype.initialize.call(this,a),this.symbolId=a.sym,this.angle=a.a,this.rotationSpeed=0,this.rotationAccel=0},update:function(a){var b=this.path[this.path.length-1];Tuio.Container.prototype.update.call(this,a);if(a.hasOwnProperty("rs")&&a.hasOwnProperty("ra"))this.angle=a.a,this.rotationSpeed=a.rs,this.rotationAccel=a.ra;else{var c=this.currentTime.subtractTime(b.getTuioTime()),d=c.getTotalMilliseconds()/1e3,e=this.angle,f=this.rotationSpeed;this.angle=a.a;var g=(this.angle-e)/(2*Math.PI);g>.75?g-=1:g<-0.75&&(g+=1),this.rotationSpeed=g/d,this.rotationAccel=(this.rotationSpeed-f)/d}this.updateObjectState()},updateObject:function(a){Tuio.Container.prototype.updateContainer.call(this,a),this.angle=a.getAngle(),this.rotationSpeed=a.getRotationSpeed(),this.rotationAccel=a.getRotationAccel(),this.updateObjectState()},updateObjectState:function(){this.rotationAccel!==0&&this.state!==Tuio.Object.TUIO_STOPPED&&(this.state=Tuio.Object.TUIO_ROTATING)},stop:function(a){this.update({ttime:a,xp:this.xPos,yp:this.yPos,a:this.angle})},getSymbolId:function(){return this.symbolId},getAngle:function(){return this.angle},getAngleDegrees:function(){return this.angle/Math.PI*180},getRotationSpeed:function(){return this.rotationSpeed},getRotationAccel:function(){return this.rotationAccel},isMoving:function(){return this.state===Tuio.Object.TUIO_ACCELERATING||this.state===Tuio.Object.TUIO_DECELERATING||this.state===Tuio.Object.TUIO_ROTATING}},{TUIO_ROTATING:5,fromObject:function(a){return new Tuio.Object({xp:a.getX(),yp:a.getY(),si:a.getSessionID(),sym:a.getSymbolId(),a:a.getAngle()})}}),Tuio.Client=Tuio.Model.extend({host:null,socket:null,connected:null,objectList:null,aliveObjectList:null,newObjectList:null,cursorList:null,aliveCursorList:null,newCursorList:null,frameObjects:null,frameCursors:null,freeCursorList:null,maxCursorId:null,currentFrame:null,currentTime:null,initialize:function(a){this.host=a.host,this.connected=!1,this.objectList={},this.aliveObjectList=[],this.newObjectList=[],this.cursorList={},this.aliveCursorList=[],this.newCursorList=[],this.frameObjects=[],this.frameCursors=[],this.freeCursorList=[],this.maxCursorId=-1,this.currentFrame=0,this.currentTime=null,_.bindAll(this,"onConnect","acceptBundle","onDisconnect")},connect:function(){Tuio.Time.initSession(),this.currentTime=new Tuio.Time,this.currentTime.reset(),this.socket=io.connect(this.host),this.socket.on("connect",this.onConnect),this.socket.on("disconnect",this.onDisconnect)},onConnect:function(){this.socket.on("osc",this.acceptBundle),this.connected=!0,this.trigger("connect")},onDisconnect:function(){this.connected=!1,this.trigger("disconnect")},isConnected:function(){return this.connected},getTuioObjects:function(){return _.clone(this.objectList)},getTuioCursors:function(){return _.clone(this.cursorList)},getTuioObject:function(a){return this.objectList[a]},getTuioCursor:function(a){return this.cursorList[a]},acceptBundle:function(a){var b=null;for(var c=0,d=a.length;c<d;c++){b=a[c];switch(b[0]){case"/tuio/2Dobj":case"/tuio/2Dcur":this.acceptMessage(b)}}},acceptMessage:function(a){var b=a[0],c=a[1],d=a.slice(2,a.length);switch(b){case"/tuio/2Dobj":this.handleObjectMessage(c,d);break;case"/tuio/2Dcur":this.handleCursorMessage(c,d)}},handleObjectMessage:function(a,b){switch(a){case"set":this.objectSet(b);break;case"alive":this.objectAlive(b);break;case"fseq":this.objectFseq(b)}},handleCursorMessage:function(a,b){switch(a){case"set":this.cursorSet(b);break;case"alive":this.cursorAlive(b);break;case"fseq":this.cursorFseq(b)}},objectSet:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9];if(!_.has(this.objectList,b)){var l=new Tuio.Object({si:b,sym:c,xp:d,yp:e,a:f});this.frameObjects.push(l)}else{var m=this.objectList[b];if(!m)return;if(m.xPos!==d||m.yPos!==e||m.angle!==f||m.xSpeed!==g||m.ySpeed!==h||m.rotationSpeed!==i||m.motionAccel!==j||m.rotationAccel!==k){var n=new Tuio.Object({si:b,sym:c,xp:d,yp:e,a:f});n.update({xp:d,yp:e,a:f,xs:g,ys:h,rs:i,ma:j,ra:k}),this.frameObjects.push(n)}}},objectAlive:function(a){var b=null;this.newObjectList=a,this.aliveObjectList=_.difference(this.aliveObjectList,this.newObjectList);for(var c=0,d=this.aliveObjectList.length;c<d;c++)b=this.objectList[this.aliveObjectList[c]],b&&(b.remove(this.currentTime),this.frameObjects.push(b))},objectFseq:function(a){var b=a[0],c=!1,d=null;b>0?(b>this.currentFrame&&(this.currentTime=Tuio.Time.getSessionTime()),b>=this.currentFrame||this.currentFrame-b>100?this.currentFrame=b:c=!0):Tuio.Time.getSessionTime().subtractTime(this.currentTime).getTotalMilliseconds()>100&&(this.currentTime=Tuio.Time.getSessionTime());if(!c){for(var e=0,f=this.frameObjects.length;e<f;e++){d=this.frameObjects[e];switch(d.getTuioState()){case Tuio.Object.TUIO_REMOVED:this.objectRemoved(d);break;case Tuio.Object.TUIO_ADDED:this.objectAdded(d);break;default:this.objectDefault(d)}}this.trigger("refresh",Tuio.Time.fromTime(this.currentTime));var g=this.aliveObjectList;this.aliveObjectList=this.newObjectList,this.newObjectList=g}this.frameObjects=[]},objectRemoved:function(a){var b=a;b.remove(this.currentTime),this.trigger("removeTuioObject",b),delete this.objectList[b.getSessionId()]},objectAdded:function(a){var b=new Tuio.Object({ttime:this.currentTime,si:a.getSessionId(),sym:a.getSymbolId(),xp:a.getX(),yp:a.getY(),a:a.getAngle()});this.objectList[b.getSessionId()]=b,this.trigger("addTuioObject",b)},objectDefault:function(a){var b=this.objectList[a.getSessionId()];a.getX()!==b.getX()&&a.getXSpeed()===0||a.getY()!==b.getY()&&a.getYSpeed()===0?b.update({ttime:this.currentTime,xp:a.getX(),yp:a.getY(),a:a.getAngle()}):b.update({ttime:this.currentTime,xp:a.getX(),yp:a.getY(),a:a.getAngle(),xs:a.getXSpeed(),ys:a.getYSpeed(),rs:a.getRotationSpeed(),ma:a.getMotionAccel(),ra:a.getRotationAccel()}),this.trigger("updateTuioObject",b)},cursorSet:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5];if(!_.has(this.cursorList,b)){var h=new Tuio.Cursor({si:b,ci:-1,xp:c,yp:d});this.frameCursors.push(h)}else{var i=this.cursorList[b];if(!i)return;if(i.xPos!==c||i.yPos!==d||i.xSpeed!==e||i.ySpeed!==f||i.motionAccel!==g){var j=new Tuio.Cursor({si:b,ci:i.getCursorId(),xp:c,yp:d});j.update({xp:c,yp:d,xs:e,ys:f,ma:g}),this.frameCursors.push(j)}}},cursorAlive:function(a){var b=null;this.newCursorList=a,this.aliveCursorList=_.difference(this.aliveCursorList,this.newCursorList);for(var c=0,d=this.aliveCursorList.length;c<d;c++)b=this.cursorList[this.aliveCursorList[c]],b&&(b.remove(this.currentTime),this.frameCursors.push(b))},cursorFseq:function(a){var b=a[0],c=!1,d=null;b>0?(b>this.currentFrame&&(this.currentTime=Tuio.Time.getSessionTime()),b>=this.currentFrame||this.currentFrame-b>100?this.currentFrame=b:c=!0):Tuio.Time.getSessionTime().subtractTime(this.currentTime).getTotalMilliseconds()>100&&(this.currentTime=Tuio.Time.getSessionTime());if(!c){for(var e=0,f=this.frameCursors.length;e<f;e++){d=this.frameCursors[e];switch(d.getTuioState()){case Tuio.Cursor.TUIO_REMOVED:this.cursorRemoved(d);break;case Tuio.Cursor.TUIO_ADDED:this.cursorAdded(d);break;default:this.cursorDefault(d)}}this.trigger("refresh",Tuio.Time.fromTime(this.currentTime));var g=this.aliveCursorList;this.aliveCursorList=this.newCursorList,this.newCursorList=g}this.frameCursors=[]},cursorRemoved:function(a){var b=a;b.remove(this.currentTime),this.trigger("removeTuioCursor",b),delete this.cursorList[b.getSessionId()];if(b.getCursorId()===this.maxCursorId){this.maxCursorId=-1;if(_.size(this.cursorList)>0){var c=_.max(this.cursorList,function(a){return a.getCursorId()});c.getCursorId()>this.maxCursorId&&(this.maxCursorId=c.getCursorId()),this.freeCursorList=_.without(this.freeCursorList,function(a){return a.getCursorId()>=this.maxCursorId})}else this.freeCursorList=[]}else b.getCursorId()<this.maxCursorId&&this.freeCursorList.push(b)},cursorAdded:function(a){var b=_.size(this.cursorList),c=null;if(b<=this.maxCursorId&&this.freeCursorList.length>0){var d=this.freeCursorList[0];for(var e=0,f=this.freeCursorList.length;e<f;e++)c=this.freeCursorList[e],c.getDistanceToPoint(a)<d.getDistanceToPoint(a)&&(d=c);b=d.getCursorId(),this.freeCursorList=_.without(this.freeCursorList,function(a){return a.getCursorId()===b})}else this.maxCursorId=b;var g=new Tuio.Cursor({ttime:this.currentTime,si:a.getSessionId(),ci:b,xp:a.getX(),yp:a.getY()});this.cursorList[g.getSessionId()]=g,this.trigger("addTuioCursor",g)},cursorDefault:function(a){var b=this.cursorList[a.getSessionId()];a.getX()!==b.getX()&&a.getXSpeed()===0||a.getY()!==b.getY()&&a.getYSpeed()===0?b.update({ttime:this.currentTime,xp:a.getX(),yp:a.getY()}):b.update({ttime:this.currentTime,xp:a.getX(),yp:a.getY(),xs:a.getXSpeed(),ys:a.getYSpeed(),ma:a.getMotionAccel()}),this.trigger("updateTuioCursor",b)}});