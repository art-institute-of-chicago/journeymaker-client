# Kiosk Mode

In kiosk mode, JourneyMaker runs on a local webserver and is managed by several Node.js processes that run in the background. If you intend to use JourneyMaker in kiosk mode, please ensure that you have the correct version of Node installed on your machine.

Briefly, here's what the various Node.js apps do:

| App | Description |
|----------:|-------------|
| AssetDownloader | Retrieves the JSON generated by the JourneyMaker CMS, downloading it and the assets it references to the kiosk localhost. |
| LogServer | Receives event messages from the `App` and logs them to text files. |
| PrintServer | Sends the generated tour booklet to a nearby printer in the galleries. |



## Requirements

Kiosk mode requires the following:

1. node v19.1.0
2. npm 8.19.3 (comes with node)
3. Xcode (Mac OS X, see [nodejs/node-gyp#569](https://github.com/nodejs/node-gyp/issues/569))
4. \*nix environment (Linux, Mac OS X, Free BSD, etc.)
5. Webserver (Apache, nginx, etc.)

## Installation

These installation instructions assume that you have read the [main readme](README.md).

1. Clone this repo to your computer.

2. Run `install.sh` and choose `2` for the kiosk mode. Assuming your prereqisites are in order, it will install the necessary `node_modules` for the Node.js apps.

3. Edit you `config.custom.json`. Set `contentOrigin` to point at the JSON file generated by your JourneyMaker CMS. Set `baseURL` to your virtual host, i.e. to the URL through which you plan to access your JourneyMaker kiosk. For instace, if using SimpleHTTPServer, set it to `http://localhost:8888`

4. Run the AssetDownloader. This will cache the JSON and assets from your JourneyMaker CMS to the kiosk. If installing in a permanent location, this script should be run once on each startup to enable updating of content.

5. Direct your webserver to serve the `App` subfolder. Configuring webservers is beyond the scope of this guide; however, you can try using Python's [SimpleHTTPServer](https://docs.python.org/2/library/simplehttpserver.html) or Mac OS X's built-in Apache.

Here is a sample sequence of terminal commands to illustrate the process:

```bash
# Download the repo, e.g. via git clone
git clone https://github.com/art-institute-of-chicago/journeymaker-client

# Enter the repo
cd journeymaker-client

# Run the install script; type 2 for kiosk mode when prompted
chmod 755 install.sh
./install.sh

# Edit your configuration file as desired
# Be sure to set contentOrigin to point at your JourneyMaker CMS
# Set baseURL to your JourneyMaker localhost
nano App/config.custom.json

# Run the AssetDownloader (requires contentOrigin to be set)
./AssetDownloader/download_assets.command

# Enter the App folder
cd App

# Serve the App folder, e.g. via SimpleHTTPServer
# After running this command, visit http://localhost:8888
python3 -m http.server 8888
```

Please note that we have not tested SimpleHTTPServer for long-term stability in kiosk applications.



## Configuration

Please see [main readme](README.md#configuration) for general config options.



### Configuring the Print Server

JourneyMaker utilizes a Node server to enable silent printing to a set of predefined printers on the local network. By design, all pages are intended to print to 11" x 17" paper. The Art Institute of Chicago additionally utilizes paper that has a pre-printed map on one side to reduce the amount of ink utilized at the time of journey creation.

In Mac OS X, after adding your printers through *System Preferences*, confirm the name of connected printers in Terminal.

```bash
lpstat -p
```

Using your text editor of choice, open `config.custom.json`

In the option `printValidPrinters`, change the listed printer names to match the printers installed on the kiosk machine. The display name is used to present users with a dialog directing them to the correct printer at the end of their session in the interactive.

You may also set a preferred printer with `printPreferredPrinter`. If this does not match the name of one of the printers listed in `printValidPrinters` the print server will randomly pick a printer from the `printValidPrinters` list at the end of each user session.

JourneyMaker also saves a copy of each printed JourneyGuide to the local disk for archiving and troubleshooting purposes. You can specify the path of the directory that you would like to save PDF's in the `printOutputPath` var. If left unspecified, PDF's will be saved to `/tmp`.

```javascript
{

    "printOutputPath": "/tmp",

    "printValidPrinters": [
        {
            "name": "Print_Station_A",
            "displayName": "Print Station A",
            "color": "#009bce"
        },
        {
            "name": "Print_Station_B",
            "displayName": "Print Station B",
            "color": "#dd4444"
        }
    ],

    "printPreferredPrinter": "random",

}
```

For more information, see `PrintServer/server.js`




### Configuring Startup Items

For full kiosk operation, add the following items to run at startup items:

1. AssetDownloader/download_assets.command
2. PrintServer/StartPrintServer.command

It is desirable to keep these Node.js processes running in the background using UserAgents, `tmux`, daemons, or similar methods. We use [LaunchControl](http://www.soma-zone.com/LaunchControl/) to manage these services for our kiosks, but feel free to use any method that works for you.
